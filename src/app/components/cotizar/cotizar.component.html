<div *ngIf="!usuarioActual" class="alerta-sesion">
  ‚ö†Ô∏è Debes iniciar sesi√≥n para poder generar una cotizaci√≥n.
  <button routerLink="/login-cliente" class="btn-iniciar">Iniciar sesi√≥n</button>
</div>

<div class="cotizar-form">
  <h2>Llena el formulario para cotizar</h2>

  <form (ngSubmit)="onSubmit()" #cotizarForm="ngForm">
    <!-- Datos personales -->
    <div class="form-group">
      <label for="nombre">Nombres y apellidos *</label>
      <input type="text" id="nombre" class="form-control" name="nombre" [(ngModel)]="formData.nombre" required>
    </div>

    <div class="form-group">
      <label for="dniRuc">DNI/RUC *</label>
      <input type="text" id="dniRuc" class="form-control" name="dniRuc" [(ngModel)]="formData.dniRuc" required>
    </div>

    <div class="form-group">
      <label for="email">Correo Electr√≥nico *</label>
      <input type="email" id="email" class="form-control" name="email" [(ngModel)]="formData.email" required>
    </div>

    <div class="form-group">
      <label for="telefonoMovil">Tel√©fono m√≥vil *</label>
      <input type="text" id="telefonoMovil" class="form-control" name="telefonoMovil" [(ngModel)]="formData.telefonoMovil" required>
    </div>

    <!-- Productos -->
    <div *ngFor="let producto of formData.productos; let i = index" class="producto-group">
      <label>Producto {{ i + 1 }}</label>
      
      <div class="producto-grid">
        <!-- Dropdown Categor√≠a -->
        <div class="dropdown-container">
          <div class="dropdown-header" (click)="toggleCategoria(i)">
            <span class="selected">
              {{ producto.categoria || 'Selecciona una categor√≠a' }}
            </span>
            <span class="arrow" [class.open]="dropdownAbiertoCategoria[i]">‚ñæ</span>
          </div>

          <div class="dropdown-body" *ngIf="dropdownAbiertoCategoria[i]">
            <input type="text"
                   placeholder="Buscar categor√≠a..."
                   [(ngModel)]="categoriaBusqueda[i]"
                   name="categoriaBusqueda{{i}}"
                   class="form-control buscador" />

            <div class="dropdown-option"
                 *ngFor="let categoria of getCategoriasFiltradas(i)"
                 (click)="selectCategoria(i, categoria)">
              {{ categoria }}
              <small class="muted"> ({{ countProductsInCategory(categoria) }})</small>
            </div>
            <div *ngIf="getCategoriasFiltradas(i).length === 0" class="dropdown-empty">
              No hay categor√≠as que coincidan
            </div>
          </div>
        </div>

        <!-- Dropdown Equipo -->
        <div class="dropdown-container" [class.disabled]="!producto.categoria">
          <div class="dropdown-header" (click)="producto.categoria ? toggleEquipo(i) : null">
            <span class="selected">
              {{ producto.equipo || (producto.categoria ? 'Selecciona un equipo' : 'Selecciona categor√≠a primero') }}
            </span>
            <span class="arrow" [class.open]="dropdownAbiertoEquipo[i]">‚ñæ</span>
          </div>

          <div class="dropdown-body" *ngIf="dropdownAbiertoEquipo[i]">
            <input type="text"
                   placeholder="Buscar equipo..."
                   [(ngModel)]="equipoBusqueda[i]"
                   name="equipoBusqueda{{i}}"
                   class="form-control buscador" />

            <div class="dropdown-option"
                 *ngFor="let equipo of getEquiposFiltrados(producto.categoria, equipoBusqueda[i])"
                 (click)="selectEquipo(i, equipo)">
              {{ equipo }}
            </div>

            <div *ngIf="getEquiposFiltrados(producto.categoria, equipoBusqueda[i]).length === 0" class="dropdown-empty">
              No hay equipos en esta categor√≠a
            </div>
          </div>
        </div>

        <!-- Cantidad -->
        <input type="number"
               class="form-control"
               [(ngModel)]="producto.cantidad"
               name="cantidad{{i}}"
               min="1"
               placeholder="Cant."
               required>

        <!-- Bot√≥n eliminar -->
        <button type="button"
                class="btn btn-danger btn-sm eliminar-btn"
                (click)="quitarProducto(i)"
                *ngIf="formData.productos.length > 1">
          Eliminar
        </button>
      </div>
    </div>

    <!-- Bot√≥n agregar producto -->
    <button type="button" class="btn btn-outline-secondary btn-sm mb-3" (click)="agregarProducto()">
      + Agregar otro producto
    </button>

    <!-- Mensaje (AHORA OPCIONAL) -->
    <div class="form-group">
      <label for="mensaje">Mensaje (opcional)</label>
      <textarea id="mensaje" 
                class="form-control" 
                name="mensaje" 
                [(ngModel)]="formData.mensaje" 
                rows="4" 
                placeholder="Escribe aqu√≠ cualquier detalle adicional sobre tu cotizaci√≥n..."></textarea>
    </div>

    <!-- Contacto -->
    <div class="form-group">
      <label>¬øC√≥mo deseas que te contactemos? *</label>
      
      <div class="form-check">
        <input type="radio" 
               id="telefono" 
               name="contacto" 
               [(ngModel)]="formData.contacto" 
               value="Telefono"
               required>
        <label for="telefono">Tel√©fono</label>
      </div>
      
      <div class="form-check">
        <input type="radio" 
               id="whatsapp" 
               name="contacto" 
               [(ngModel)]="formData.contacto" 
               value="Whatsapp">
        <label for="whatsapp">WhatsApp</label>
      </div>
      
      <div class="form-check">
        <input type="radio" 
               id="correo" 
               name="contacto" 
               [(ngModel)]="formData.contacto" 
               value="Correo">
        <label for="correo">Correo</label>
      </div>
    </div>

    <!-- T√©rminos -->
    <div class="form-check">
      <input type="checkbox" id="terminos" name="terminos" [(ngModel)]="formData.terminos" required>
      <label for="terminos">Acepto t√©rminos y condiciones *</label>
    </div>

    <!-- Bot√≥n PDF -->
    <button type="button" class="btn btn-outline-primary mt-3" (click)="generarPDF()">
      üßæ Generar Cotizaci√≥n PDF
    </button>
  </form>
</div>